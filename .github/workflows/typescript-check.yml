name: 'TypeScript & Error Detection'

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  type-check:
    runs-on: ubuntu-latest
    name: 'TypeScript Compilation & Error Detection'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: TypeScript compilation check (full project)
      run: |
        echo "🔍 Checking TypeScript compilation for entire project..."
        npx tsc --noEmit --project . || echo "❌ TypeScript errors detected - see details above"
      continue-on-error: true
      
    - name: TypeScript compilation check (server/storage.ts)
      run: |
        echo "🔍 Checking server/storage.ts specifically..."
        npx tsc --noEmit server/storage.ts || echo "❌ Server storage TypeScript errors detected"
      continue-on-error: true
      
    - name: ESLint check
      run: |
        echo "🔍 Running ESLint checks..."
        npx eslint . --ext .ts,.tsx,.js,.jsx --fix-dry-run || echo "❌ ESLint issues detected"
      continue-on-error: true
      
    - name: Schema validation
      run: |
        echo "🔍 Checking Drizzle schema consistency..."
        npx drizzle-kit introspect --config=drizzle.config.ts || echo "❌ Schema issues detected"
      continue-on-error: true
      
    - name: Import/Export validation
      run: |
        echo "🔍 Testing critical imports and exports..."
        node -e "
          try {
            console.log('Testing shared schema import...');
            const schema = require('./shared/schema.ts');
            console.log('✅ Schema imports working');
          } catch (e) {
            console.log('❌ Schema import issues:', e.message);
          }
          
          try {
            console.log('Testing server storage import...');
            const storage = require('./server/storage.ts');
            console.log('✅ Storage imports working');
          } catch (e) {
            console.log('❌ Storage import issues:', e.message);
          }
        " || echo "❌ Import validation completed with issues"

  build-test:
    runs-on: ubuntu-latest
    name: 'Build & Integration Test'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build frontend
      run: |
        echo "🔍 Building frontend application..."
        npm run build || echo "❌ Build errors detected"
      continue-on-error: true
      
    - name: TypeScript type checking (client)
      run: |
        echo "🔍 Type checking client-side TypeScript..."
        npx tsc --noEmit client/src/**/*.ts client/src/**/*.tsx || echo "❌ Client TypeScript errors detected"
      continue-on-error: true
      
    - name: TypeScript type checking (server)
      run: |
        echo "🔍 Type checking server-side TypeScript..."
        npx tsc --noEmit server/**/*.ts || echo "❌ Server TypeScript errors detected"
      continue-on-error: true

  comprehensive-analysis:
    runs-on: ubuntu-latest
    name: 'Comprehensive Code Analysis'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Dead code detection
      run: |
        echo "🔍 Searching for potential dead code..."
        find . -name "*.ts" -o -name "*.tsx" | grep -v node_modules | xargs grep -l "TODO\|FIXME\|XXX" || echo "✅ No TODO/FIXME markers found"
      continue-on-error: true
      
    - name: Dependency analysis
      run: |
        echo "🔍 Analyzing dependencies..."
        npm audit --audit-level=moderate || echo "❌ Dependency vulnerabilities detected"
      continue-on-error: true
      
    - name: File structure validation
      run: |
        echo "🔍 Validating project structure..."
        echo "📁 Core files check:"
        ls -la package.json tsconfig.json drizzle.config.ts || echo "❌ Missing core configuration files"
        echo "📁 Source directories check:"
        ls -la server/ client/ shared/ || echo "❌ Missing source directories"
        echo "✅ Structure validation complete"