name: 'TypeScript & Error Detection'

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  type-check:
    runs-on: ubuntu-latest
    name: 'TypeScript Compilation & Error Detection'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: TypeScript compilation check (full project)
      run: |
        echo "ğŸ” Checking TypeScript compilation for entire project..."
        npx tsc --noEmit --project . || echo "âŒ TypeScript errors detected - see details above"
      continue-on-error: true
      
    - name: TypeScript compilation check (server/storage.ts)
      run: |
        echo "ğŸ” Checking server/storage.ts specifically..."
        npx tsc --noEmit server/storage.ts || echo "âŒ Server storage TypeScript errors detected"
      continue-on-error: true
      
    - name: ESLint check
      run: |
        echo "ğŸ” Running ESLint checks..."
        npx eslint . --ext .ts,.tsx,.js,.jsx --fix-dry-run || echo "âŒ ESLint issues detected"
      continue-on-error: true
      
    - name: Schema validation
      run: |
        echo "ğŸ” Checking Drizzle schema consistency..."
        npx drizzle-kit introspect --config=drizzle.config.ts || echo "âŒ Schema issues detected"
      continue-on-error: true
      
    - name: Import/Export validation
      run: |
        echo "ğŸ” Testing critical imports and exports..."
        node -e "
          try {
            console.log('Testing shared schema import...');
            const schema = require('./shared/schema.ts');
            console.log('âœ… Schema imports working');
          } catch (e) {
            console.log('âŒ Schema import issues:', e.message);
          }
          
          try {
            console.log('Testing server storage import...');
            const storage = require('./server/storage.ts');
            console.log('âœ… Storage imports working');
          } catch (e) {
            console.log('âŒ Storage import issues:', e.message);
          }
        " || echo "âŒ Import validation completed with issues"

  build-test:
    runs-on: ubuntu-latest
    name: 'Build & Integration Test'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build frontend
      run: |
        echo "ğŸ” Building frontend application..."
        npm run build || echo "âŒ Build errors detected"
      continue-on-error: true
      
    - name: TypeScript type checking (client)
      run: |
        echo "ğŸ” Type checking client-side TypeScript..."
        npx tsc --noEmit client/src/**/*.ts client/src/**/*.tsx || echo "âŒ Client TypeScript errors detected"
      continue-on-error: true
      
    - name: TypeScript type checking (server)
      run: |
        echo "ğŸ” Type checking server-side TypeScript..."
        npx tsc --noEmit server/**/*.ts || echo "âŒ Server TypeScript errors detected"
      continue-on-error: true

  comprehensive-analysis:
    runs-on: ubuntu-latest
    name: 'Comprehensive Code Analysis'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Dead code detection
      run: |
        echo "ğŸ” Searching for potential dead code..."
        find . -name "*.ts" -o -name "*.tsx" | grep -v node_modules | xargs grep -l "TODO\|FIXME\|XXX" || echo "âœ… No TODO/FIXME markers found"
      continue-on-error: true
      
    - name: Dependency analysis
      run: |
        echo "ğŸ” Analyzing dependencies..."
        npm audit --audit-level=moderate || echo "âŒ Dependency vulnerabilities detected"
      continue-on-error: true
      
    - name: File structure validation
      run: |
        echo "ğŸ” Validating project structure..."
        echo "ğŸ“ Core files check:"
        ls -la package.json tsconfig.json drizzle.config.ts || echo "âŒ Missing core configuration files"
        echo "ğŸ“ Source directories check:"
        ls -la server/ client/ shared/ || echo "âŒ Missing source directories"
        echo "âœ… Structure validation complete"