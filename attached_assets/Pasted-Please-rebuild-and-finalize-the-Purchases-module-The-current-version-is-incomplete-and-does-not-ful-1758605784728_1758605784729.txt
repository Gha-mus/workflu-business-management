Please rebuild and finalize the Purchases module. The current version is incomplete and does not fully reflect our business process. Below are the exact specifications you must implement in detail, step by step, with no deviations.

Page Layout

Purchases page must have 2 sections:

Purchase History Table (default view, with filters and actions)

New Purchase Form (modal or dedicated page)

1. Purchase History Table
Columns

The purchase history table must include:

Date – date of purchase order

Supplier Name (linked to SupplierID)

Weight (kg) – total weight purchased

Price per kg (in purchase currency)

Total Purchase Value = Weight * Price/kg

Amount Paid – cumulative payments made

Remaining Balance = Total - Paid

Payment Method (Cash / Credit / Advance / Other)

Funding Source (Capital / External loan / Other)

Actions:

Edit purchase

View details

Record payment

Cancel purchase (if not linked downstream)

Filters

Date range filter

Supplier filter

Status filter (Paid / Partial / Unpaid)

2. New Purchase Form
Required Fields

Purchase ID (auto-generated)

Supplier – dropdown linked to Suppliers table (SupplierID, Name, Contact, etc.)

Date

Weight (kg) – must be > 0

Price per kg – must be > 0

Currency (USD/ETB selectable)

FX Rate – read-only (from central Settings)

Payment & Funding Fields

Payment Method:

Cash (immediate full payment)

Credit (0 now, full later)

Advance (partial upfront, rest later)

Other (free text)

Funding Source:

Capital (system balance)

External (loan/partner funds)

3. Calculations

Total Purchase Value = Weight * Price per kg

Remaining Balance = Total - Paid

FX Conversion = Total * FX Rate (if currency ≠ USD)

4. Posting Rules

Once a purchase is confirmed, stock must automatically be added into the FIRST Warehouse under status = Unfiltered.

Purchases must be linked to Order IDs (if applicable).

If canceled:

Stock deducted from FIRST Warehouse

Ledger entry reversed

5. Payments

Support multiple payments per purchase.

Each payment entry: amount, method, date, funding source, reference note.

Automatically update Remaining Balance.

Must not allow overpayment.

6. Validation

Required: Supplier, Weight, Price/kg, Payment Method, Funding Source.

No negative or zero weights.

FX rate read-only (must come from central settings).

7. Integration

Warehouse Module: Purchases feed into FIRST warehouse automatically.

Operating Expenses: Linked if there are associated costs (e.g. supplier fees).

Reports & Summaries: Must reflect purchase totals, balances, and funding sources.

8. Audit & Logging

Every action (create/edit/cancel/payment) must be logged with:

User

Timestamp

Old vs new values

Audit log must be immutable.

9. Acceptance Criteria

I must be able to:

Create a new purchase → stock goes to FIRST warehouse.

Record partial payment → remaining balance updates correctly.

Apply different payment methods (cash/credit/advance).

Cancel purchase → stock deducted, ledger reversed.

See full purchase history with filters.

See balances and totals in reports.

Supabase JWT auth enforced on all endpoints.

Automated tests must pass for:

Purchase creation

Payment recording

Cancelation workflow

Stock posting rules

10. Cleanup

Remove any placeholder/demo purchases.

Keep system clean with only actual purchases entered via the new form.

This is the final structure required for the Purchases module. Please implement everything exactly as described, and confirm with full end-to-end tests